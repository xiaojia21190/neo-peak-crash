// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// 用户模型 - 存储 Linux DO 用户信息
model User {
  id         String  @id // Linux DO 用户 ID
  username   String  @unique
  name       String?
  avatar     String?
  trustLevel Int     @default(0)
  active     Boolean @default(true)
  silenced   Boolean @default(false)

  // 余额信息
  balance     Decimal @default(0) @db.Decimal(18, 2) // LDC 余额
  playBalance Decimal @default(10000) @db.Decimal(18, 2) // 游戏模式余额

  // 统计信息
  totalWins   Int     @default(0)
  totalLosses Int     @default(0)
  totalBets   Int     @default(0)
  totalProfit Decimal @default(0) @db.Decimal(18, 2)

  // 时间戳
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastLoginAt DateTime @default(now())

  // 关联
  bets         Bet[]
  transactions Transaction[]

  @@map("users")
}

// 游戏回合模型
model Round {
  id     String      @id @default(cuid())
  asset  String      // 交易对 (BTCUSDT, ETHUSDT)
  status RoundStatus @default(PENDING)

  // Provably Fair
  serverSeed String? // 服务端种子（回合结束后公开）
  commitHash String  // SHA256(serverSeed) - 回合开始时公开
  clientSeed String? // 可选客户端种子

  // 价格数据
  startPrice Decimal  @db.Decimal(18, 8)
  endPrice   Decimal? @db.Decimal(18, 8)

  // 统计
  totalBets   Int     @default(0)
  totalVolume Decimal @default(0) @db.Decimal(18, 2)
  totalPayout Decimal @default(0) @db.Decimal(18, 2)

  // 时间
  startedAt DateTime
  endedAt   DateTime?

  // 关联
  bets      Bet[]
  snapshots PriceSnapshot[]

  @@index([asset, status])
  @@index([startedAt])
  @@map("rounds")
}

// 价格快照（时序数据）
model PriceSnapshot {
  id      String @id @default(cuid())
  roundId String
  round   Round  @relation(fields: [roundId], references: [id], onDelete: Cascade)

  timestamp DateTime // 精确到毫秒
  price     Decimal  @db.Decimal(18, 8)
  rowIndex  Decimal  @db.Decimal(10, 4) // 计算后的行索引

  @@index([roundId, timestamp])
  @@map("price_snapshots")
}

// 投注记录模型
model Bet {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 回合关联（新增）
  roundId String?
  round   Round?  @relation(fields: [roundId], references: [id], onDelete: SetNull)

  // 投注信息
  amount     Decimal @db.Decimal(18, 2) // 投注金额
  multiplier Decimal @db.Decimal(10, 4) // 目标倍率
  rowIndex   Int // 行索引（兼容旧字段）
  colIndex   Int // 列索引（兼容旧字段）

  // 新增：精确目标
  targetRow  Decimal? @db.Decimal(10, 4) // 目标行（精确值）
  targetTime Decimal? @db.Decimal(10, 3) // 目标时间（秒，相对回合开始）

  // 结果
  status BetStatus @default(PENDING)
  isWin  Boolean   @default(false)
  payout Decimal   @default(0) @db.Decimal(18, 2) // 实际赔付

  // 命中详情（新增）
  hitPrice Decimal? @db.Decimal(18, 8) // 命中时的价格
  hitRow   Decimal? @db.Decimal(10, 4) // 命中时的行
  hitTime  Decimal? @db.Decimal(10, 3) // 命中时的时间

  // 游戏信息
  asset      String // 交易对 (如 BTCUSDT)
  roundHash  String? // 回合哈希（兼容旧字段）
  isPlayMode Boolean @default(false) // 是否为游戏模式

  // 时间戳
  createdAt DateTime  @default(now())
  settledAt DateTime? // 结算时间

  @@index([userId, createdAt])
  @@index([roundId, status])
  @@map("bets")
}

// 交易记录模型 (充值/提现)
model Transaction {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 交易信息
  type   TransactionType
  amount Decimal           @db.Decimal(18, 2)
  status TransactionStatus @default(PENDING)

  // 支付信息
  orderNo String? @unique // 订单号
  tradeNo String? // 第三方交易号

  // 备注
  remark String?

  // 时间戳
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  @@index([userId])
  @@index([orderNo])
  @@map("transactions")
}

enum TransactionType {
  RECHARGE // 充值
  WITHDRAW // 提现
  BET_WIN // 投注赢
  BET_LOSE // 投注输
}

enum TransactionStatus {
  PENDING // 待处理
  COMPLETED // 已完成
  FAILED // 失败
  CANCELLED // 已取消
}

// 回合状态
enum RoundStatus {
  PENDING   // 准备中
  BETTING   // 投注阶段
  RUNNING   // 运行中
  SETTLING  // 结算中
  COMPLETED // 已完成
  CANCELLED // 已取消
}

// 投注状态
enum BetStatus {
  PENDING   // 待结算
  WON       // 已赢
  LOST      // 已输
  CANCELLED // 已取消（回合取消时）
  REFUNDED  // 已退款
}
